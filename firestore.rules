rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Ana kullanıcı dokümanı - sadece kendi hesabına erişim
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Öğrenci profilleri (aile hesabı sistemi)
      match /studentProfiles/{profileId} {
        // Sadece veli kendi öğrenci profillerine erişebilir
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Öğrenci profil detayları
        match /privateProfile/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        
        // Öğrenci gamification verileri
        match /gamification/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        
        // Öğrenci planları
        match /plan/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        
        // Öğrenci analytics verileri
        match /analytics/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        
        // Öğrenci performans verileri
        match /performance/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        
        // Öğrenci performance_analytics verisi
        match /performance_analytics {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
      
      // Geriye uyumluluk için eski veri yapısı
      // Tek kullanıcı sistemi için mevcut kurallar
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Leaderboard verileri - tüm kullanıcılar okuyabilir, sadece sistem yazabilir
    match /leaderboard/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Sadece Cloud Functions yazabilir
    }
    
    // Global leaderboard için gamification collection'larını oku
    // CollectionGroup sorguları için özel izin
    match /{path=**}/gamification/{document} {
      allow read: if request.auth != null 
        && document == 'data'; // Sadece data dokümanına erişim
    }
    
    // Sistem rozetleri - herkes okuyabilir
    match /badges/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Sadece admin yazabilir
    }
    
    // Sistem başarımları - herkes okuyabilir
    match /achievements/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Sadece admin yazabilir
    }
    
    // Müfredat verileri - herkes okuyabilir
    match /curriculum/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Sadece admin yazabilir
    }
    
    // Plan oluşturma sırası - kullanıcılar sadece kendi kayıtlarını okuyabilir
    match /planGenerationQueue/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Sadece Cloud Functions yazabilir
    }
    
    // Admin koleksiyonları - sadece admin erişimi
    match /admin/{document=**} {
      allow read, write: if request.auth != null 
        && request.auth.token.email != null 
        && request.auth.token.email.matches('.*@okuz\\.ai$');
    }
  }
}